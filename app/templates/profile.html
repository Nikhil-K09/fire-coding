{% extends 'base.html' %}
{% block content %}

<div class="profile-container">
  <div class="profile-header">
    <h2>{{ username }}</h2>
    <a href="{{ url_for('auth.logout') }}" class="logout-btn">Sign Out</a>
  </div>

  <div class="profile-stats" style="margin-bottom: 30px;">
    <p><strong>Solved Problems: </strong> {{ solved_count }}</p>
  </div>

  <div id="heatmap" class="heatmap" style="display:flex; justify-content:center; padding:40px;"></div>

  <h3 style="padding-bottom: 7px;">Submissions</h3>
  <table class="submissions-table">
    <thead>
      <tr>
        <th>Problem</th>
        <th>Language</th>
        <th>Submitted At</th>
        <th>Status</th>
        <th>Code</th>
      </tr>
    </thead>
    <tbody>
      {% for sub in submissions %}
        <tr>
          <td>{{ sub.problem_title }}</td>
          <td>{{ sub.lang_name }}</td>
          <td>{{ sub.submitted_at }}</td>
          <td>
            {% if sub.test_case_result %}
              {% if sub.test_case_result.status == "Accepted" %}
                <span class="status status--accepted">Accepted</span>
              {% elif sub.test_case_result.status == "Rejected" %}
                <span class="status status--rejected">Rejected</span>
              {% else %}
                <span class="status status--pending">{{ sub.test_case_result.status }}</span>
              {% endif %}
            {% else %}
              <span class="status status--gray">Pending</span>
            {% endif %}
          </td>
          <td>
            <button class="view-code-btn" 
                    data-code="{{ sub.code | e }}"
                    data-lang="{{ sub.lang_name }}">
              View Code
            </button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="codeModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modalLang"></h3>
    <pre id="modalCode" class="code-block"></pre>
  </div>
</div>

<!-- Heatmap Script (unchanged) -->
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
  const solvedDates = new Set({{ solved_dates|tojson }});

  const rows = 7;
  const cols = 54;
  const cellSize = 18;
  const cellPadding = 4;

  const svgWidth = cols * (cellSize + cellPadding) + 50;
  const svgHeight = rows * (cellSize + cellPadding) + 25;

  const svg = d3.select("#heatmap")
    .append("svg")
    .attr("width", svgWidth)
    .attr("height", svgHeight);

  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - (rows*cols - 1));

  const days = [];
  for (let i = 0; i < rows * cols; i++) {
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);
    days.push(d);
  }

  function formatDateLocal(d) {
    return d.toISOString().slice(0,10);
  }

  svg.selectAll("rect")
    .data(days)
    .enter()
    .append("rect")
    .attr("width", cellSize)
    .attr("height", cellSize)
    .attr("x", (d,i) => Math.floor(i/rows) * (cellSize + cellPadding) + 40)
    .attr("y", d => d.getDay() * (cellSize + cellPadding) + 20)
    .attr("fill", d => solvedDates.has(formatDateLocal(d)) ? "#FF7A00" : "#e0e0e0")
    .attr("rx", 4)
    .attr("ry", 4);

  const months = d3.timeMonths(days[0], today);
  svg.selectAll("text")
    .data(months)
    .enter()
    .append("text")
    .attr("x", d => {
      const i = days.findIndex(day => day.getMonth() === d.getMonth() && day.getDate() === 1);
      return Math.floor(i/rows) * (cellSize + cellPadding) + 40;
    })
    .attr("y", 12)
    .text(d => d3.timeFormat("%b")(d))
    .style("font-size", "12px")
    .style("fill", "#555")
    .style("font-weight", "600");

  const dayLabels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  svg.selectAll(".dayLabel")
    .data(dayLabels)
    .enter()
    .append("text")
    .attr("x", 0)
    .attr("y", (d,i) => i * (cellSize + cellPadding) + 20 + cellSize/1.5)
    .text(d => d)
    .style("font-size", "10px")
    .style("fill", "#555");
</script>

<!-- Modal Script -->
<script>
  const modal = document.getElementById("codeModal");
  const modalCode = document.getElementById("modalCode");
  const modalLang = document.getElementById("modalLang");
  const closeBtn = document.querySelector(".modal .close");

  document.querySelectorAll(".view-code-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      modal.style.display = "block";
      modalCode.textContent = btn.dataset.code;
      modalLang.textContent = "Language: " + btn.dataset.lang;
    });
  });

  closeBtn.onclick = () => modal.style.display = "none";
  window.onclick = (event) => {
    if (event.target == modal) modal.style.display = "none";
  };
</script>


{% endblock %}
